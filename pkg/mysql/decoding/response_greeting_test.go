package decoding_test

import (
	"testing"

	"github.com/colinnewell/pcap2mysql-log/pkg/mysql/structure"
)

func TestNotAllowedGreeting(t *testing.T) {
	input := []byte{
		0x42, 0x00, 0x00, 0x00, 0xff, 0x6a, 0x04, 0x48, 0x6f, 0x73, 0x74, 0x20, 0x27, 0x31, // B....j.Host '1
		0x32, 0x37, 0x2e, 0x30, 0x2e, 0x30, 0x2e, 0x31, 0x27, 0x20, 0x69, 0x73, 0x20, 0x6e, 0x6f, 0x74, // 27.0.0.1' is not
		0x20, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x65, 0x64, 0x20, 0x74, 0x6f, 0x20, 0x63, 0x6f, 0x6e, 0x6e, //  allowed to conn
		//nolint:misspell
		0x65, 0x63, 0x74, 0x20, 0x74, 0x6f, 0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x4d, 0x79, 0x53, 0x51, // ect to this MySQ
		0x4c, 0x20, 0x73, 0x65, 0x72, 0x76, 0x65, 0x72, // L server
	}

	expected := []interface{}{
		structure.ErrorResponse{
			Code:       1130,
			CorePacket: structure.CorePacket{Type: "Error"},
			Message:    "Host '127.0.0.1' is not allowed to connect to this MySQL server",
		},
	}

	testResponse(t, input, expected)
}
